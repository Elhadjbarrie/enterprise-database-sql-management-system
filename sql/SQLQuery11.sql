USE THE_RED_DB;
GO

-- Réinitialisation optionnelle pour rejouer le script en développement
IF OBJECT_ID('CHAT_MESSAGE', 'U') IS NOT NULL DROP TABLE CHAT_MESSAGE;
IF OBJECT_ID('CHAT_PARTICIPANT', 'U') IS NOT NULL DROP TABLE CHAT_PARTICIPANT;
IF OBJECT_ID('CHAT_CONVERSATION', 'U') IS NOT NULL DROP TABLE CHAT_CONVERSATION;
IF OBJECT_ID('ETUDIANT', 'U') IS NOT NULL DROP TABLE ETUDIANT;
IF OBJECT_ID('DEPARTEMENT_UNIV', 'U') IS NOT NULL DROP TABLE DEPARTEMENT_UNIV;
GO

CREATE TABLE DEPARTEMENT_UNIV (
    ID_DEPARTEMENT   INT           NOT NULL,
    CODE_DEPARTEMENT CHAR(5)       NOT NULL,
    NOM              VARCHAR(150)  NOT NULL,
    CONSTRAINT PK_DEPARTEMENT_UNIV PRIMARY KEY (ID_DEPARTEMENT),
    CONSTRAINT UQ_DEPARTEMENT_CODE UNIQUE (CODE_DEPARTEMENT)
);
GO

CREATE TABLE ETUDIANT (
    CODE_PERMANENT   CHAR(12)      NOT NULL,
    NOM              VARCHAR(100)  NOT NULL,
    PRENOM           VARCHAR(100)  NOT NULL,
    COURRIEL         VARCHAR(150)  NOT NULL,
    ID_DEPARTEMENT   INT           NOT NULL,
    DATE_INSCRIPTION DATE          NOT NULL DEFAULT GETDATE(),
    CONSTRAINT PK_ETUDIANT PRIMARY KEY (CODE_PERMANENT),
    CONSTRAINT FK_ETUDIANT_DEPARTEMENT FOREIGN KEY (ID_DEPARTEMENT)
        REFERENCES DEPARTEMENT_UNIV(ID_DEPARTEMENT),
    CONSTRAINT UQ_ETUDIANT_COURRIEL UNIQUE (COURRIEL)
);
GO

CREATE TABLE CHAT_CONVERSATION (
    ID_CONVERSATION  INT           NOT NULL,
    TITRE            VARCHAR(200)  NOT NULL,
    TYPE_CONVERSATION VARCHAR(30)  NOT NULL, -- ex: GROUPE, DIRECT
    CREE_PAR         CHAR(12)      NOT NULL,
    DATE_CREATION    DATETIME      NOT NULL DEFAULT GETDATE(),
    CONSTRAINT PK_CHAT_CONVERSATION PRIMARY KEY (ID_CONVERSATION),
    CONSTRAINT FK_CHAT_CONV_CREATEUR FOREIGN KEY (CREE_PAR)
        REFERENCES ETUDIANT(CODE_PERMANENT),
    CONSTRAINT CK_CHAT_TYPE CHECK (TYPE_CONVERSATION IN ('GROUPE', 'DIRECT'))
);
GO

CREATE TABLE CHAT_PARTICIPANT (
    ID_CONVERSATION INT          NOT NULL,
    CODE_PERMANENT  CHAR(12)     NOT NULL,
    ROLE_PARTICIPANT VARCHAR(30) NOT NULL DEFAULT 'MEMBRE', -- MEMBRE ou ADMIN
    DATE_REJOINT    DATETIME     NOT NULL DEFAULT GETDATE(),
    CONSTRAINT PK_CHAT_PARTICIPANT PRIMARY KEY (ID_CONVERSATION, CODE_PERMANENT),
    CONSTRAINT FK_CHAT_PARTICIPANT_CONV FOREIGN KEY (ID_CONVERSATION)
        REFERENCES CHAT_CONVERSATION(ID_CONVERSATION),
    CONSTRAINT FK_CHAT_PARTICIPANT_ETUD FOREIGN KEY (CODE_PERMANENT)
        REFERENCES ETUDIANT(CODE_PERMANENT),
    CONSTRAINT CK_ROLE_PARTICIPANT CHECK (ROLE_PARTICIPANT IN ('MEMBRE', 'ADMIN'))
);
GO

CREATE TABLE CHAT_MESSAGE (
    ID_MESSAGE      INT IDENTITY(1,1) NOT NULL,
    ID_CONVERSATION INT               NOT NULL,
    EMETTEUR        CHAR(12)          NOT NULL,
    CONTENU         NVARCHAR(2000)    NOT NULL,
    DATE_ENVOI      DATETIME          NOT NULL DEFAULT GETDATE(),
    CONSTRAINT PK_CHAT_MESSAGE PRIMARY KEY (ID_MESSAGE),
    CONSTRAINT FK_CHAT_MESSAGE_CONV FOREIGN KEY (ID_CONVERSATION)
        REFERENCES CHAT_CONVERSATION(ID_CONVERSATION),
    CONSTRAINT FK_CHAT_MESSAGE_EMETTEUR FOREIGN KEY (EMETTEUR)
        REFERENCES ETUDIANT(CODE_PERMANENT),
    CONSTRAINT CK_CHAT_MESSAGE_CONTENU CHECK (LEN(LTRIM(RTRIM(CONTENU))) > 0)
);
GO

-- Index pour la recherche par code permanent, nom/prénom et département
CREATE INDEX IX_ETUDIANT_CODE_PERMANENT ON ETUDIANT(CODE_PERMANENT);
CREATE INDEX IX_ETUDIANT_NOM_PRENOM ON ETUDIANT(NOM, PRENOM);
CREATE INDEX IX_ETUDIANT_DEPARTEMENT ON ETUDIANT(ID_DEPARTEMENT);
CREATE INDEX IX_CHAT_MSG_CONV ON CHAT_MESSAGE(ID_CONVERSATION, DATE_ENVOI DESC);
GO

-- Jeu de données de démonstration
INSERT INTO DEPARTEMENT_UNIV (ID_DEPARTEMENT, CODE_DEPARTEMENT, NOM) VALUES
(1, 'INF', 'Informatique'),
(2, 'ADM', 'Administration'),
(3, 'BIO', 'Biologie');
GO

INSERT INTO ETUDIANT (CODE_PERMANENT, NOM, PRENOM, COURRIEL, ID_DEPARTEMENT, DATE_INSCRIPTION) VALUES
('ABCD12345678', 'Diallo', 'Mariam', 'mariam.diallo@univ.ca', 1, '2023-08-28'),
('EFGH23456789', 'Nguyen', 'Alex', 'alex.nguyen@univ.ca', 1, '2022-09-01'),
('IJKL34567890', 'Bernard', 'Camille', 'camille.bernard@univ.ca', 2, '2024-01-10'),
('MNOP45678901', 'Smith', 'Jordan', 'jordan.smith@univ.ca', 3, '2023-09-05'),
('QRST56789012', 'Fall', 'Aminata', 'aminata.fall@univ.ca', 2, '2024-02-15');
GO

INSERT INTO CHAT_CONVERSATION (ID_CONVERSATION, TITRE, TYPE_CONVERSATION, CREE_PAR, DATE_CREATION) VALUES
(100, 'Orientation des nouveaux étudiants', 'GROUPE', 'ABCD12345678', '2024-08-20T09:00:00'),
(200, 'Projet de base de données', 'GROUPE', 'EFGH23456789', '2024-09-10T18:30:00'),
(300, 'Discussion directe: Camille & Aminata', 'DIRECT', 'IJKL34567890', '2024-09-15T11:00:00');
GO

INSERT INTO CHAT_PARTICIPANT (ID_CONVERSATION, CODE_PERMANENT, ROLE_PARTICIPANT, DATE_REJOINT) VALUES
(100, 'ABCD12345678', 'ADMIN', '2024-08-20T09:00:00'),
(100, 'EFGH23456789', 'MEMBRE', '2024-08-20T09:05:00'),
(100, 'IJKL34567890', 'MEMBRE', '2024-08-21T10:15:00'),
(200, 'EFGH23456789', 'ADMIN', '2024-09-10T18:30:00'),
(200, 'ABCD12345678', 'MEMBRE', '2024-09-10T18:35:00'),
(200, 'IJKL34567890', 'MEMBRE', '2024-09-10T18:36:00'),
(300, 'IJKL34567890', 'ADMIN', '2024-09-15T11:00:00'),
(300, 'QRST56789012', 'MEMBRE', '2024-09-15T11:00:00');
GO

INSERT INTO CHAT_MESSAGE (ID_CONVERSATION, EMETTEUR, CONTENU, DATE_ENVOI) VALUES
(100, 'ABCD12345678', N'Bienvenue à tous dans le groupe Orientation!', '2024-08-20T09:01:00'),
(100, 'EFGH23456789', N'Quand auront lieu les visites du campus?', '2024-08-20T09:02:30'),
(200, 'EFGH23456789', N'Partagez vos idées de schéma relationnel ici.', '2024-09-10T18:31:00'),
(200, 'IJKL34567890', N'Je peux préparer le diagramme Merise pour demain.', '2024-09-10T18:45:10'),
(300, 'IJKL34567890', N'Peux-tu valider le formulaire d''inscription?', '2024-09-15T11:02:00'),
(300, 'QRST56789012', N'Oui, je regarde et je te reviens dans 10 minutes.', '2024-09-15T11:03:15');
GO

-- Vue pour rechercher rapidement un étudiant par code permanent, nom/prénom ou département
IF OBJECT_ID('V_RECHERCHE_ETUDIANTS', 'V') IS NOT NULL DROP VIEW V_RECHERCHE_ETUDIANTS;
GO
CREATE VIEW V_RECHERCHE_ETUDIANTS AS
SELECT
    e.CODE_PERMANENT,
    e.NOM,
    e.PRENOM,
    e.COURRIEL,
    d.CODE_DEPARTEMENT,
    d.NOM AS NOM_DEPARTEMENT,
    e.DATE_INSCRIPTION,
    CONCAT(e.PRENOM, ' ', e.NOM) AS NOM_COMPLET
FROM ETUDIANT e
INNER JOIN DEPARTEMENT_UNIV d ON e.ID_DEPARTEMENT = d.ID_DEPARTEMENT;
GO

-- Exemple de requête : récupérer les messages d''un étudiant par son code permanent ou son nom
--
-- SELECT m.ID_MESSAGE, m.DATE_ENVOI, m.CONTENU, c.TITRE
-- FROM CHAT_MESSAGE m
-- INNER JOIN ETUDIANT e ON m.EMETTEUR = e.CODE_PERMANENT
-- INNER JOIN CHAT_CONVERSATION c ON m.ID_CONVERSATION = c.ID_CONVERSATION
-- WHERE e.CODE_PERMANENT = 'ABCD12345678' OR (e.NOM = 'Diallo' AND e.PRENOM = 'Mariam')
-- ORDER BY m.DATE_ENVOI DESC;
